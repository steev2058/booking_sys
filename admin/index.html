<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>لوحة التحكم - بنك البركة</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{--orange:#f57c00;--red:#c62828;--gray:#546e7a;--bg:#f5f6f8;--card:#fff;--line:#d7dbe2;--ink:#263238}
    *{box-sizing:border-box}
    body{font-family:'Cairo',sans-serif;background:var(--bg);margin:0;color:var(--ink)}
    .top{background:#fff;border-bottom:5px solid #2f2f2f}
    .top-in{max-width:1280px;margin:auto;display:flex;align-items:center;justify-content:space-between;padding:10px 14px}
    .logo{height:52px}.service{background:linear-gradient(120deg,var(--orange),var(--red));color:#fff;padding:10px 18px;border-radius:0 0 0 26px;font-weight:800}
    .main{max-width:1280px;margin:16px auto;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:12px;box-shadow:0 8px 22px rgba(0,0,0,.05)}
    .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}.tab{padding:9px 14px;border:2px solid #b0bec5;border-radius:12px;background:#fff;cursor:pointer;font-weight:800;color:#546e7a}.tab.active{background:var(--gray);border-color:var(--gray);color:#fff}
    .section{display:none}.section.active{display:block}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}.col{flex:1;min-width:170px}
    input,select{width:100%;padding:10px;border:2px solid #cfd8dc;border-radius:12px;background:#fff;font-weight:700}
    input:focus,select:focus{outline:none;border-color:var(--orange)}
    button{padding:9px 12px;border:0;border-radius:10px;background:linear-gradient(120deg,var(--orange),var(--red));color:#fff;font-weight:800;cursor:pointer}
    button.ghost{background:#eceff1;color:#455a64}
    button.danger{background:#b71c1c}
    .table-wrap{overflow:auto;-webkit-overflow-scrolling:touch}
    table{width:100%;border-collapse:collapse;min-width:860px}th,td{border:1px solid #d7e2f0;padding:7px;text-align:right}th{background:#f5f8ff}
    .hide{display:none}
    h3{margin:0 0 10px}
    @media(max-width:900px){
      .top-in{padding:8px 10px}
      .logo{height:42px}
      .service{padding:8px 12px;font-size:13px;border-radius:0 0 0 18px}
      .main{padding:0 8px}
      .card{padding:10px}
      .tabs{gap:6px}
      .tab{font-size:12px;padding:8px 10px}
      .row{flex-direction:column;align-items:stretch}
      .col{min-width:100%}
      button{width:100%}
    }
  </style>
</head>
<body>
<div class="top"><div class="top-in"><img class="logo" src="/albaraka-logo.jpg" alt="logo"><div class="service">لوحة تحكم الحجوزات</div></div></div>
<div class="main">
  <div class="card" id="loginCard">
    <h3>تسجيل دخول لوحة التحكم</h3>
    <div class="row"><div class="col"><input id="u" placeholder="username"></div><div class="col"><input id="p" type="password" placeholder="password"></div><button onclick="login()">دخول</button></div>
  </div>

  <div id="panel" class="hide">
    <div class="tabs">
      <div id="tab-appts" class="tab active" onclick="showSection('appts')">المواعيد</div>
      <div id="tab-branches" class="tab" onclick="showSection('branches')">الفروع</div>
      <div id="tab-companies" class="tab" onclick="showSection('companies')">الشركات</div>
      <div id="tab-days" class="tab" onclick="showSection('days')">أيام الدوام</div>
    </div>

    <div id="sec-appts" class="section active card">
      <h3>المواعيد</h3>
      <div class="row"><div class="col"><input id="f" placeholder="فلترة branch_id"></div><div class="col"><input id="d" placeholder="فلترة day_name"></div><button onclick="loadAppointments()">فلترة</button></div>
      <div class="table-wrap"><table><thead><tr><th>ID</th><th>الفرع</th><th>الشركة</th><th>اليوم</th><th>الوقت</th><th>الهاتف</th><th>الحالة</th><th>إجراء</th></tr></thead><tbody id="tb"></tbody></table></div>
    </div>

    <div id="sec-branches" class="section card">
      <h3>إدارة الفروع</h3>
      <div class="row"><div class="col"><input id="b_code" placeholder="رمز الفرع"></div><div class="col"><input id="b_name" placeholder="اسم الفرع"></div><div class="col"><input id="b_loc" placeholder="الموقع"></div><button onclick="addBranch()">إضافة</button></div>
      <div class="table-wrap"><table><thead><tr><th>ID</th><th>Code</th><th>Name</th><th>Location</th><th>Active</th><th>إجراءات</th></tr></thead><tbody id="branchesTb"></tbody></table></div>
    </div>

    <div id="sec-companies" class="section card">
      <h3>إدارة شركات الحوالات</h3>
      <div class="row"><div class="col"><input id="c_name" placeholder="اسم الشركة"></div><div class="col"><input id="c_desc" placeholder="الوصف"></div><button onclick="addCompany()">إضافة</button></div>
      <div class="table-wrap"><table><thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Active</th><th>إجراءات</th></tr></thead><tbody id="companiesTb"></tbody></table></div>
    </div>

    <div id="sec-days" class="section card">
      <h3>إدارة أيام الدوام</h3>
      <div class="row"><div class="col"><input id="d_branch" placeholder="branch_id"></div><div class="col"><input id="d_name" placeholder="day_name"></div><div class="col"><input id="d_start" placeholder="09:00"></div><div class="col"><input id="d_end" placeholder="15:00"></div><div class="col"><input id="d_int" placeholder="60"></div><button onclick="addBusinessDay()">إضافة</button></div>
      <div class="table-wrap"><table><thead><tr><th>ID</th><th>Branch</th><th>Day</th><th>Start</th><th>End</th><th>Interval</th><th>Active</th><th>إجراءات</th></tr></thead><tbody id="daysTb"></tbody></table></div>
    </div>
  </div>
</div>
<div id="toast" style="position:fixed;left:16px;bottom:16px;background:#263238;color:#fff;padding:10px 14px;border-radius:10px;font-weight:700;display:none;z-index:9999"></div>

<script>
let token=''; let role=''; let myBranchId=null;
async function j(u,o={}){const r=await fetch(u,o);return await r.json()}
const h=()=>({Authorization:'Bearer '+token,'content-type':'application/json'});
function showToast(text, ok=true){const t=document.getElementById('toast');t.textContent=text;t.style.background=ok?'#1b5e20':'#b00020';t.style.display='block';clearTimeout(window.__toastTimer);window.__toastTimer=setTimeout(()=>t.style.display='none',2500)}
function confirmAction(text){return window.confirm(text)}
function showSection(name){['appts','branches','companies','days'].forEach(k=>{document.getElementById('sec-'+k).classList.toggle('active',k===name);document.getElementById('tab-'+k).classList.toggle('active',k===name)});if(role!=='admin'&&(name==='branches'||name==='companies'))showSection('appts');}
async function login(){const r=await j('/api/admin/login',{method:'POST',headers:{'content-type':'application/json'},body:JSON.stringify({username:u.value,password:p.value})});if(!r.token){showToast(r.error||'فشل تسجيل الدخول',false);return;}token=r.token;role=r.role;myBranchId=r.branch_id;loginCard.classList.add('hide');panel.classList.remove('hide');if(role!=='admin'){document.getElementById('tab-branches').style.display='none';document.getElementById('tab-companies').style.display='none';d_branch.value=myBranchId||'';}await loadAppointments();if(role==='admin'){await loadBranches();await loadCompanies();}await loadDays();showToast('تم تسجيل الدخول بنجاح');}
async function loadAppointments(){const q=[];if(f.value)q.push('branch_id='+encodeURIComponent(f.value));if(d.value)q.push('day_name='+encodeURIComponent(d.value));const r=await j('/api/admin/appointments'+(q.length?'?'+q.join('&'):''),{headers:{Authorization:'Bearer '+token}});tb.innerHTML=(r.appointments||[]).map(x=>`<tr><td>${x.id}</td><td>${x.branch_name}</td><td>${x.company_name}</td><td>${x.day_name}</td><td>${x.slot_time}</td><td>${x.phone}</td><td>${x.status}</td><td>${role==='admin'?`<button class="danger" onclick="delAppt(${x.id})">حذف</button>`:''}</td></tr>`).join('');}
async function delAppt(id){if(!confirmAction('تأكيد حذف هذا الموعد؟'))return;await fetch('/api/admin/appointments/'+id,{method:'DELETE',headers:{Authorization:'Bearer '+token}});await loadAppointments();showToast('تم حذف الموعد');}
async function loadBranches(){const r=await j('/api/admin/branches',{headers:{Authorization:'Bearer '+token}});branchesTb.innerHTML=(r.branches||[]).map(x=>`<tr><td>${x.id}</td><td><input id='bc_${x.id}' value='${x.code}'></td><td><input id='bn_${x.id}' value='${x.name}'></td><td><input id='bl_${x.id}' value='${x.location}'></td><td><select id='ba_${x.id}'><option value='1' ${x.active?'selected':''}>1</option><option value='0' ${!x.active?'selected':''}>0</option></select></td><td><button class='ghost' onclick='updBranch(${x.id})'>تعديل</button> <button class='danger' onclick='delBranch(${x.id})'>حذف</button></td></tr>`).join('');}
async function addBranch(){await fetch('/api/admin/branches',{method:'POST',headers:h(),body:JSON.stringify({code:b_code.value,name:b_name.value,location:b_loc.value})});await loadBranches();showToast('تمت إضافة الفرع');}
async function updBranch(id){if(!confirmAction('تأكيد تعديل بيانات الفرع؟'))return;await fetch('/api/admin/branches/'+id,{method:'PUT',headers:h(),body:JSON.stringify({code:document.getElementById('bc_'+id).value,name:document.getElementById('bn_'+id).value,location:document.getElementById('bl_'+id).value,active:Number(document.getElementById('ba_'+id).value)})});await loadBranches();showToast('تم تعديل الفرع');}
async function delBranch(id){if(!confirmAction('تأكيد حذف الفرع؟'))return;await fetch('/api/admin/branches/'+id,{method:'DELETE',headers:{Authorization:'Bearer '+token}});await loadBranches();showToast('تم حذف الفرع');}
async function loadCompanies(){const r=await j('/api/admin/companies',{headers:{Authorization:'Bearer '+token}});companiesTb.innerHTML=(r.companies||[]).map(x=>`<tr><td>${x.id}</td><td><input id='cn_${x.id}' value='${x.name}'></td><td><input id='cd_${x.id}' value='${x.description||''}'></td><td><select id='ca_${x.id}'><option value='1' ${x.active?'selected':''}>1</option><option value='0' ${!x.active?'selected':''}>0</option></select></td><td><button class='ghost' onclick='updCompany(${x.id})'>تعديل</button> <button class='danger' onclick='delCompany(${x.id})'>حذف</button></td></tr>`).join('');}
async function addCompany(){await fetch('/api/admin/companies',{method:'POST',headers:h(),body:JSON.stringify({name:c_name.value,description:c_desc.value})});await loadCompanies();showToast('تمت إضافة الشركة');}
async function updCompany(id){if(!confirmAction('تأكيد تعديل بيانات الشركة؟'))return;await fetch('/api/admin/companies/'+id,{method:'PUT',headers:h(),body:JSON.stringify({name:document.getElementById('cn_'+id).value,description:document.getElementById('cd_'+id).value,active:Number(document.getElementById('ca_'+id).value)})});await loadCompanies();showToast('تم تعديل الشركة');}
async function delCompany(id){if(!confirmAction('تأكيد حذف الشركة؟'))return;await fetch('/api/admin/companies/'+id,{method:'DELETE',headers:{Authorization:'Bearer '+token}});await loadCompanies();showToast('تم حذف الشركة');}
async function loadDays(){const r=await j('/api/admin/business-days',{headers:{Authorization:'Bearer '+token}});daysTb.innerHTML=(r.business_days||[]).map(x=>`<tr><td>${x.id}</td><td><input id='db_${x.id}' value='${x.branch_id}' ${role==='branch_employee'?'disabled':''}></td><td><input id='dd_${x.id}' value='${x.day_name}'></td><td><input id='ds_${x.id}' value='${x.start_time}'></td><td><input id='de_${x.id}' value='${x.end_time}'></td><td><input id='di_${x.id}' value='${x.interval_minutes}'></td><td><select id='da_${x.id}'><option value='1' ${x.active?'selected':''}>1</option><option value='0' ${!x.active?'selected':''}>0</option></select></td><td><button class='ghost' onclick='updDay(${x.id})'>تعديل</button> <button class='danger' onclick='delDay(${x.id})'>حذف</button></td></tr>`).join('');}
async function addBusinessDay(){await fetch('/api/admin/business-days',{method:'POST',headers:h(),body:JSON.stringify({branch_id:Number(role==='branch_employee'?myBranchId:d_branch.value),day_name:d_name.value,start_time:d_start.value,end_time:d_end.value,interval_minutes:Number(d_int.value||60),active:1})});await loadDays();showToast('تمت إضافة يوم دوام');}
async function updDay(id){if(!confirmAction('تأكيد تعديل يوم الدوام؟'))return;await fetch('/api/admin/business-days/'+id,{method:'PUT',headers:h(),body:JSON.stringify({branch_id:Number(role==='branch_employee'?myBranchId:document.getElementById('db_'+id).value),day_name:document.getElementById('dd_'+id).value,start_time:document.getElementById('ds_'+id).value,end_time:document.getElementById('de_'+id).value,interval_minutes:Number(document.getElementById('di_'+id).value||60),active:Number(document.getElementById('da_'+id).value)})});await loadDays();showToast('تم تعديل يوم الدوام');}
async function delDay(id){if(!confirmAction('تأكيد حذف يوم الدوام؟'))return;await fetch('/api/admin/business-days/'+id,{method:'DELETE',headers:{Authorization:'Bearer '+token}});await loadDays();showToast('تم حذف يوم الدوام');}
</script>
</body>
</html>
